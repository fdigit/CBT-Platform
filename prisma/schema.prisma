// MongoDB-compatible Prisma schema
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

/// -----------------------------
/// User & Roles
/// -----------------------------
model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  password  String
  name      String
  role      Role
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  school    School?     @relation(fields: [schoolId], references: [id])
  schoolId  String?     @db.ObjectId

  StudentProfile Student?
  SchoolAdminProfile SchoolAdmin?
  TeacherProfile Teacher?
  notifications Notification[]
  reviewedLessonPlans LessonPlan[]
  approvedExams Exam[] @relation("ExamApprover")
  approvedResults AcademicResult[] @relation("ResultApprover")
  announcements Announcement[] @relation("AnnouncementAuthor")
  announcementComments AnnouncementComment[] @relation("CommentAuthor")
}

enum Role {
  SUPER_ADMIN
  SCHOOL_ADMIN
  TEACHER
  STUDENT
}

enum SchoolStatus {
  PENDING
  APPROVED
  SUSPENDED
  REJECTED
}

/// -----------------------------
/// School & Management
/// -----------------------------
model School {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  slug      String   @unique
  email     String   @unique
  phone     String?
  logoUrl   String?
  status    SchoolStatus @default(PENDING)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users       User[]
  admins      SchoolAdmin[]
  teachers    Teacher[]
  students    Student[]
  classes     Class[]
  exams       Exam[]
  payments    Payment[]
  subjects    Subject[]
  assignments Assignment[]
  lessonPlans LessonPlan[]
  academicResults AcademicResult[] @relation("SchoolResults")
  gradingScales GradingScale[] @relation("SchoolGradingScale")
  termSessions TermSession[] @relation("SchoolTermSessions")
  announcements Announcement[]
}

/// School Admin profile (links to User)
model SchoolAdmin {
  id      String @id @default(auto()) @map("_id") @db.ObjectId
  userId  String @unique @db.ObjectId
  schoolId String @db.ObjectId
  user    User   @relation(fields: [userId], references: [id])
  school  School @relation(fields: [schoolId], references: [id])
}

/// Teacher profile (links to User)
model Teacher {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  userId      String @unique @db.ObjectId
  schoolId    String @db.ObjectId
  employeeId  String @unique
  
  // Professional Information
  qualification String?
  specialization String?
  experience    Int? // years of experience
  phone         String?
  address       String?
  avatar        String?
  
  // Status and Activity
  status        TeacherStatus @default(ACTIVE)
  hireDate      DateTime?
  lastLogin     DateTime?
  
  // Relations
  user          User   @relation(fields: [userId], references: [id])
  school        School @relation(fields: [schoolId], references: [id])
  subjects      TeacherSubject[]
  classSubjects ClassSubject[]
  classes       TeacherClass[]
  assignments   Assignment[]
  lessonPlans   LessonPlan[]
  gradedSubmissions AssignmentSubmission[]
  exams         Exam[]
  academicResults AcademicResult[] @relation("TeacherResults")
}

/// Class model for organizing students and teachers
model Class {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  schoolId    String @db.ObjectId
  name        String // e.g., "SS 1", "JSS 2", "Grade 5"
  section     String? // e.g., "A", "B", "C"
  academicYear String // e.g., "2024/2025"
  
  // Class Information
  description String?
  maxStudents Int @default(40)
  room        String? // classroom number/name
  
  // Status and Metadata
  status      ClassStatus @default(ACTIVE)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  school      School    @relation(fields: [schoolId], references: [id])
  students    Student[]
  exams       Exam[]
  subjects    ClassSubject[]
  teachers    TeacherClass[]
  assignments Assignment[]
  lessonPlans LessonPlan[]
  academicResults AcademicResult[] @relation("ClassResults")
  
  @@unique([schoolId, name, section, academicYear])
}

/// Student profile (links to User)
model Student {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  userId   String @unique @db.ObjectId
  schoolId String @db.ObjectId
  regNumber String @unique // Changed from regNo to regNumber for clarity
  
  // Personal Information
  gender       Gender?
  classId      String? @db.ObjectId
  parentPhone  String?
  parentEmail  String?
  dateOfBirth  String?
  address      String?
  avatar       String?
  
  // Status and Activity
  status         StudentStatus @default(ACTIVE)
  lastLogin      DateTime?
  lastExamTaken  DateTime?
  
  // Relations
  user     User   @relation(fields: [userId], references: [id])
  school   School @relation(fields: [schoolId], references: [id])
  class    Class? @relation(fields: [classId], references: [id])
  answers  Answer[]
  results  Result[]
  examAttempts ExamAttempt[]
  submissions AssignmentSubmission[]
  academicResults AcademicResult[] @relation("AcademicResults")
}

enum Gender {
  MALE
  FEMALE
}

enum StudentStatus {
  ACTIVE
  SUSPENDED
  GRADUATED
  ALUMNI
  PENDING
}

enum TeacherStatus {
  ACTIVE
  SUSPENDED
  TERMINATED
  ON_LEAVE
}

enum ClassStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

/// -----------------------------
/// Exams & Questions
/// -----------------------------
model Exam {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  duration    Int       // in minutes
  shuffle     Boolean   @default(false)
  negativeMarking Boolean @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Teacher and approval fields
  teacherId   String? @db.ObjectId
  teacher     Teacher?  @relation(fields: [teacherId], references: [id])
  
  // Subject and class assignment
  subjectId   String? @db.ObjectId
  subject     Subject?  @relation(fields: [subjectId], references: [id])
  
  // Exam configuration
  totalMarks  Int?
  passingMarks Int?
  status      ExamStatus @default(DRAFT)
  publishedAt DateTime?
  approvedBy  String? @db.ObjectId
  approver    User?     @relation("ExamApprover", fields: [approvedBy], references: [id])
  approvedAt  DateTime?
  rejectionReason String?
  
  // Assignment options
  assignmentType ExamAssignmentType @default(CLASS_WIDE)
  assignedStudentIds Json? // Array of student IDs for specific assignment
  
  // Additional settings
  allowPreview Boolean @default(false)
  showResultsImmediately Boolean @default(false)
  maxAttempts Int @default(1)
  hasMediaAttachments Boolean @default(false)
  aiGenerated Boolean @default(false)
  
  // Manual control settings
  manualControl Boolean @default(false) // If true, admin controls exam status manually
  isLive Boolean @default(false) // Manual live status (overrides time-based)
  isCompleted Boolean @default(false) // Manual completion status (overrides time-based)

  // Relations
  schoolId String @db.ObjectId
  school   School   @relation(fields: [schoolId], references: [id])
  classId  String? @db.ObjectId
  class    Class?   @relation(fields: [classId], references: [id])
  questions Question[]
  answers   Answer[]
  results   Result[]
  attempts  ExamAttempt[]
}

model Question {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  text      String    // Keep as 'text' to match existing database
  type      QuestionType
  options   Json?     // for MCQ/TrueFalse
  correctAnswer Json? // correct choice(s) or essay guidelines
  points    Float     @default(1)
  order     Int?      // Question order in exam
  imageUrl  String?   // Media attachments
  audioUrl  String?
  videoUrl  String?
  explanation String? // Explanation for correct answer
  difficulty QuestionDifficulty @default(MEDIUM)
  tags      Json?     // Array of tags

  // Relations
  examId String @db.ObjectId
  exam   Exam      @relation(fields: [examId], references: [id])
  answers Answer[]
}

enum QuestionType {
  MCQ
  TRUE_FALSE
  ESSAY
  SHORT_ANSWER
  FILL_IN_BLANK
  MATCHING
}

enum QuestionDifficulty {
  EASY
  MEDIUM
  HARD
}

enum ExamStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  PUBLISHED
  SCHEDULED
  ACTIVE
  COMPLETED
  CANCELLED
  REJECTED
}

enum ExamAssignmentType {
  CLASS_WIDE
  SPECIFIC_STUDENTS
}

enum AttemptStatus {
  STARTED
  IN_PROGRESS
  SUBMITTED
  ABANDONED
}

/// -----------------------------
/// Exam Attempts, Answers & Results
/// -----------------------------
model ExamAttempt {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  examId      String   @db.ObjectId
  studentId   String   @db.ObjectId
  attemptNumber Int    @default(1)
  startedAt   DateTime @default(now())
  submittedAt DateTime?
  timeSpent   Int?     // in minutes
  status      AttemptStatus @default(STARTED)
  ipAddress   String?
  userAgent   String?

  // Relations
  exam     Exam     @relation(fields: [examId], references: [id])
  student  Student  @relation(fields: [studentId], references: [id])

  @@unique([studentId, examId, attemptNumber])
}

model Answer {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  studentId String   @db.ObjectId
  questionId String  @db.ObjectId
  examId    String   @db.ObjectId
  attemptId String?  @db.ObjectId
  response  Json?
  isCorrect Boolean?
  pointsAwarded Float?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  student  Student  @relation(fields: [studentId], references: [id])
  question Question @relation(fields: [questionId], references: [id])
  exam     Exam     @relation(fields: [examId], references: [id])

  @@unique([studentId, questionId, examId])
}

model Result {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  studentId String   @db.ObjectId
  examId    String   @db.ObjectId
  score     Float
  gradedAt  DateTime @default(now())

  // Relations
  student Student @relation(fields: [studentId], references: [id])
  exam    Exam    @relation(fields: [examId], references: [id])

  @@unique([studentId, examId])
}

/// -----------------------------
/// Payments
/// -----------------------------
model Payment {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  schoolId  String   @db.ObjectId
  amount    Float
  currency  String   @default("NGN")
  status    PaymentStatus
  reference String   @unique
  createdAt DateTime @default(now())

  // Relations
  school School @relation(fields: [schoolId], references: [id])
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

/// -----------------------------
/// Notifications
/// -----------------------------
model Notification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  title     String
  message   String
  type      NotificationType
  isRead    Boolean  @default(false)
  userId    String   @db.ObjectId // Super admin user ID
  metadata  Json?    // Additional data (schoolId, etc.)
  createdAt DateTime @default(now())
  
  // Relations
  user User @relation(fields: [userId], references: [id])
}

enum NotificationType {
  SCHOOL_REGISTRATION
  SCHOOL_APPROVED
  SCHOOL_REJECTED
  PAYMENT_RECEIVED
  SYSTEM_ALERT
  ASSIGNMENT_CREATED
  ASSIGNMENT_SUBMITTED
  ASSIGNMENT_GRADED
  LESSON_PLAN_SUBMITTED
  LESSON_PLAN_APPROVED
  LESSON_PLAN_REJECTED
  LESSON_PLAN_NEEDS_REVISION
  EXAM_CREATED
  EXAM_SUBMITTED_FOR_APPROVAL
  EXAM_APPROVED
  EXAM_REJECTED
  EXAM_PUBLISHED
  EXAM_REMINDER
  EXAM_STARTED
  EXAM_SUBMITTED
  EXAM_GRADED
  EXAM_RESULTS_AVAILABLE
  ANNOUNCEMENT_POSTED
  ANNOUNCEMENT_COMMENT_ADDED
}

/// -----------------------------
/// Subjects & Relationships
/// -----------------------------
model Subject {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  schoolId    String @db.ObjectId
  name        String // e.g., "Mathematics", "English Language"
  code        String? // e.g., "MATH101", "ENG101"
  description String?
  
  // Status and Metadata
  status      SubjectStatus @default(ACTIVE)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  school        School @relation(fields: [schoolId], references: [id])
  teachers      TeacherSubject[]
  classSubjects ClassSubject[]
  assignments   Assignment[]
  lessonPlans   LessonPlan[]
  exams         Exam[]
  academicResults AcademicResult[] @relation("SubjectResults")
  
  @@unique([schoolId, name])
  @@unique([schoolId, code])
}

enum SubjectStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

/// Many-to-many relationship between Teachers and Subjects
model TeacherSubject {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  teacherId String @db.ObjectId
  subjectId String @db.ObjectId
  createdAt DateTime @default(now())
  
  // Relations
  teacher Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  @@unique([teacherId, subjectId])
}

/// Many-to-many relationship between Classes, Teachers, and Subjects
model ClassSubject {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  classId   String @db.ObjectId
  teacherId String @db.ObjectId
  subjectId String @db.ObjectId
  createdAt DateTime @default(now())
  
  // Relations
  class   Class   @relation(fields: [classId], references: [id], onDelete: Cascade)
  teacher Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  @@unique([classId, teacherId, subjectId])
}

/// Many-to-many relationship between Teachers and Classes
model TeacherClass {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  teacherId String @db.ObjectId
  classId   String @db.ObjectId
  createdAt DateTime @default(now())
  
  // Relations
  teacher Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  class   Class   @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  @@unique([teacherId, classId])
}

/// -----------------------------
/// Assignments & Notes
/// -----------------------------
model Assignment {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  instructions String?
  type        AssignmentType @default(ASSIGNMENT)
  
  // Scheduling
  dueDate     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Grading
  maxScore    Float @default(100)
  status      AssignmentStatus @default(DRAFT)
  
  // Relations
  schoolId    String @db.ObjectId
  teacherId   String @db.ObjectId
  classId     String? @db.ObjectId
  subjectId   String? @db.ObjectId
  
  school      School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teacher     Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  class       Class? @relation(fields: [classId], references: [id], onDelete: SetNull)
  subject     Subject? @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  
  // Assignment content
  attachments AssignmentAttachment[]
  submissions AssignmentSubmission[]
}

enum AssignmentType {
  ASSIGNMENT
  NOTE
  RESOURCE
  HOMEWORK
  PROJECT
  QUIZ
  TEST
}

enum AssignmentStatus {
  DRAFT
  PUBLISHED
  CLOSED
  ARCHIVED
}

model AssignmentAttachment {
  id           String @id @default(auto()) @map("_id") @db.ObjectId
  assignmentId String @db.ObjectId
  fileName     String
  originalName String
  filePath     String
  fileSize     Int
  mimeType     String
  uploadedAt   DateTime @default(now())
  
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
}

model AssignmentSubmission {
  id           String @id @default(auto()) @map("_id") @db.ObjectId
  assignmentId String @db.ObjectId
  studentId    String @db.ObjectId
  
  // Submission content
  textContent  String?
  submittedAt  DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Grading
  score        Float?
  feedback     String?
  gradedAt     DateTime?
  gradedBy     String? @db.ObjectId // Teacher ID
  status       SubmissionStatus @default(SUBMITTED)
  
  // Relations
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student      Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  grader       Teacher? @relation(fields: [gradedBy], references: [id], onDelete: SetNull)
  
  // Submission files
  attachments  SubmissionAttachment[]
  
  @@unique([assignmentId, studentId])
}

enum SubmissionStatus {
  SUBMITTED
  LATE
  GRADED
  RETURNED
  MISSING
}

model SubmissionAttachment {
  id           String @id @default(auto()) @map("_id") @db.ObjectId
  submissionId String @db.ObjectId
  fileName     String
  originalName String
  filePath     String
  fileSize     Int
  mimeType     String
  uploadedAt   DateTime @default(now())
  
  submission   AssignmentSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
}

/// -----------------------------
/// Lesson Plans
/// -----------------------------
model LessonPlan {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  topic       String?
  duration    Int // in minutes
  
  // Content
  objectives  String[] // JSON array of learning objectives
  materials   String[] // JSON array of materials needed
  activities  String[] // JSON array of lesson activities
  assessment  String? // Assessment method
  homework    String? // Homework assignment
  notes       String? // Additional notes
  
  // Scheduling
  scheduledDate DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Status and approval
  status        LessonPlanStatus @default(DRAFT)
  reviewStatus  ReviewStatus @default(PENDING)
  reviewNotes   String?
  reviewedAt    DateTime?
  reviewedBy    String? @db.ObjectId // Admin/HOD user ID
  
  // Relations
  schoolId      String @db.ObjectId
  teacherId     String @db.ObjectId
  classId       String? @db.ObjectId
  subjectId     String? @db.ObjectId
  
  school        School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teacher       Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  class         Class? @relation(fields: [classId], references: [id], onDelete: SetNull)
  subject       Subject? @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  reviewer      User? @relation(fields: [reviewedBy], references: [id], onDelete: SetNull)
  
  // Resources
  resources     LessonPlanResource[]
}

enum LessonPlanStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
  NEEDS_REVISION
}

model LessonPlanResource {
  id           String @id @default(auto()) @map("_id") @db.ObjectId
  lessonPlanId String @db.ObjectId
  fileName     String
  originalName String
  filePath     String
  fileSize     Int
  mimeType     String
  resourceType ResourceType @default(DOCUMENT)
  uploadedAt   DateTime @default(now())
  
  lessonPlan   LessonPlan @relation(fields: [lessonPlanId], references: [id], onDelete: Cascade)
}

enum ResourceType {
  DOCUMENT
  VIDEO
  AUDIO
  IMAGE
  PRESENTATION
  SPREADSHEET
  OTHER
}

/// -----------------------------
/// Academic Results Module
/// -----------------------------

/// Academic result for continuous assessment and exam scores
/// This is separate from the Result model (which tracks CBT exam results)
model AcademicResult {
  id                  String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Relationships
  studentId           String   @db.ObjectId
  subjectId           String   @db.ObjectId
  teacherId           String   @db.ObjectId
  classId             String   @db.ObjectId
  schoolId            String   @db.ObjectId
  
  // Academic Period
  term                String   // "First Term", "Second Term", "Third Term"
  session             String   // "2024/2025", "2023/2024"
  
  // Scores
  caScore             Float?   @default(0) // Continuous Assessment (usually out of 40)
  examScore           Float?   @default(0) // Exam score (usually out of 60)
  totalScore          Float    // Auto-computed: caScore + examScore
  
  // Grading
  actualGrade         String   // A*, A, B, C, D, E, F
  targetedGrade       String?  // Optional: Grade student is aiming for
  gradePoint          Float    // 5.0, 4.5, 4.0, etc.
  remark              String?  // "Excellent", "Very Good", "Good", etc.
  
  // Metadata
  scoresObtainable    Float    @default(100) // Usually 100
  scoresObtained      Float    // Same as totalScore
  average             Float?   // Class average for this subject
  
  // Status and Approval
  status              ResultStatus @default(DRAFT)
  submittedAt         DateTime?
  approvedByAdmin     Boolean  @default(false)
  approvedBy          String?  @db.ObjectId
  approvedAt          DateTime?
  
  // Teacher Comments
  teacherComment      String?
  hodComment          String?  // Head of Department
  principalComment    String?
  
  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  student             Student  @relation("AcademicResults", fields: [studentId], references: [id], onDelete: Cascade)
  subject             Subject  @relation("SubjectResults", fields: [subjectId], references: [id], onDelete: Cascade)
  teacher             Teacher  @relation("TeacherResults", fields: [teacherId], references: [id], onDelete: Cascade)
  class               Class    @relation("ClassResults", fields: [classId], references: [id], onDelete: Cascade)
  school              School   @relation("SchoolResults", fields: [schoolId], references: [id], onDelete: Cascade)
  approver            User?    @relation("ResultApprover", fields: [approvedBy], references: [id], onDelete: SetNull)
  
  @@unique([studentId, subjectId, term, session])
  @@index([schoolId, classId, term, session])
  @@index([studentId, term, session])
  @@index([teacherId, term, session])
  @@index([status])
}

enum ResultStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  PUBLISHED
}

/// Configurable grading scale per school
model GradingScale {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  schoolId    String   @db.ObjectId
  
  minScore    Float    // Minimum percentage (e.g., 90)
  maxScore    Float    // Maximum percentage (e.g., 100)
  grade       String   // "A*", "A", "B", etc.
  gradePoint  Float    // 5.0, 4.5, 4.0, etc.
  remark      String   // "Excellent", "Very Good", etc.
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  school      School   @relation("SchoolGradingScale", fields: [schoolId], references: [id], onDelete: Cascade)
  
  @@index([schoolId, isActive])
}

/// Academic terms and sessions management
model TermSession {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  schoolId    String   @db.ObjectId
  
  term        String   // "First Term", "Second Term", "Third Term"
  session     String   // "2024/2025"
  startDate   DateTime
  endDate     DateTime
  
  isCurrent   Boolean  @default(false)
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  school      School   @relation("SchoolTermSessions", fields: [schoolId], references: [id], onDelete: Cascade)
  
  @@unique([schoolId, term, session])
  @@index([schoolId, isCurrent])
}

/// -----------------------------
/// Announcements System
/// -----------------------------

/// Announcement model for school-wide and targeted communications
model Announcement {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  title         String
  content       String
  authorId      String   @db.ObjectId
  authorRole    Role
  schoolId      String   @db.ObjectId
  
  // Targeting
  targetAudience TargetAudience @default(STUDENTS)
  classIds      Json?    // Array of class IDs for targeted announcements
  subjectIds    Json?    // Array of subject IDs for targeted announcements
  recipientIds  Json?    // Array of specific user IDs when using individual selection
  
  // Status and metadata
  isPinned      Boolean  @default(false)
  isPublished   Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  author        User     @relation("AnnouncementAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  school        School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  comments      AnnouncementComment[]
  
  @@index([schoolId, createdAt])
  @@index([authorId, createdAt])
  @@index([targetAudience, isPublished])
}

/// Announcement comment for threaded discussions
model AnnouncementComment {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  content         String
  announcementId  String   @db.ObjectId
  authorId        String   @db.ObjectId
  parentCommentId String?  @db.ObjectId // For threaded replies
  
  // Metadata
  isEdited        Boolean  @default(false)
  editedAt        DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  announcement    Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  author          User         @relation("CommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  parentComment   AnnouncementComment? @relation("CommentReplies", fields: [parentCommentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies         AnnouncementComment[] @relation("CommentReplies")
  
  @@index([announcementId, createdAt])
  @@index([authorId, createdAt])
  @@index([parentCommentId])
}

enum TargetAudience {
  STUDENTS
  TEACHERS
  ALL
}